name: Sync with upstream

on:
  schedule:
    - cron: "0 0 * * 1" # Every Monday at midnight UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase on upstream main
        run: |
          git remote add upstream https://github.com/RooCodeInc/Roo-Code.git
          git fetch upstream
          git rebase upstream/main
          git push origin main --force-with-lease

      - name: Create issue on conflict
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });
            if (existing.data.length > 0) {
              console.log('Issue already exists, skipping creation');
              return;
            }
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Upstream sync failed - manual resolution needed',
              labels: ['upstream-sync'],
              body: [
                'The automated upstream rebase encountered conflicts.',
                '',
                '**To resolve manually:**',
                '```bash',
                'git fetch upstream',
                'git rebase upstream/main',
                '# Resolve conflicts in each file, then:',
                'git add <resolved-files>',
                'git rebase --continue',
                'git push origin main --force-with-lease',
                '```',
                '',
                'Once resolved, close this issue.'
              ].join('\n')
            });
